% Author: Daniel Vartanian.
% Licence: MIT. See <https://opensource.org/license/mit/> to learn more.
% Based on: template.tex, developed by the Quarto team and
%   abtex2-modelo-trabalho-academico.tex, v-1.9.7, developed by
%   Lauro César Araujo and the team behind abnt2tex, with additional guidance
%   from the theses and dissertations regulations of the University of São Paulo
%   (USP). For more information, please visit <http://www.abntex.net.br/>.

% For help, see:
% * <https://quarto.org/docs/reference/formats/pdf.html>
% * <https://github.com/abntex/abntex2/wiki/ComoCustomizar>
% * <https://www.ctan.org/pkg/abntex2>
% * <https://www.ctan.org/pkg/memoir>
% * <https://www.ctan.org/pkg/hyperref>

% TODO:
% * Slightly move the toc to the left, in a way that the spacing between titles
%   and numbers become the same as the textual chapters.
% * Remove the hyperlink in the section numbering within TOC.
% * Remove hiperlink spans by page breaks. See: <https://tex.stackexchange.com/questions/54136/hyperref-link-spans-a-pagebreak-looks-ugly>.

% -----
% Preamble
% -----

% Set options for packages loaded elsewhere -----

\PassOptionsToPackage{unicode$for(hyperrefoptions)$,$hyperrefoptions$$endfor$}{hyperref}
\PassOptionsToPackage{hyphens}{url}
$if(colorlinks)$
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
$endif$

$if(CJKmainfont)$
\PassOptionsToPackage{space}{xeCJK}
$endif$

% Set \documentclass -----

$doc-class.tex()$

% Load packages -----

\usepackage{array}
\usepackage{booktabs}
\usepackage{calc}
\usepackage{color}
\usepackage{colortbl}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{enumitem}
\usepackage{etoolbox}
\usepackage{float}
\usepackage[$if(fontenc)$$fontenc$$else$T1$endif$]{fontenc}
\usepackage[hang]{footmisc}
\usepackage{graphicx}
\usepackage{iftex}
\usepackage{indentfirst}
\usepackage[utf8]{inputenc}
\usepackage{lastpage}
\usepackage{lipsum}
\usepackage{longtable}
\usepackage{microtype}
\usepackage{multirow}
\usepackage{parskip}
\usepackage{pdfpages}
\usepackage[table]{xcolor}

\usepackage[
  font=footnotesize,
  justification=centering,
  skip = 1\baselineskip
  ]{caption}

\usepackage{hyperref}

\ifPDFTeX
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
$if(mathspec)$
  \ifXeTeX
    \usepackage{mathspec} % this also loads fontspec
  \else
    \usepackage{unicode-math} % this also loads fontspec
  \fi
$else$
  \usepackage{unicode-math}
$endif$
\fi

% Set page layout -----

\setlength{\headsep}{1cm}
\setlength{\footskip}{1cm}
\checkandfixthelayout

% Set text -----

\renewcommand{\familydefault}{\sfdefault}

$if(linestretch)$
\renewcommand{\baselinestretch}{$linestretch$}
$endif$

$if(parindent)$
\setlength{\parindent}{$parindent$}
$endif$

$if(parskip)$
\setlength{\parskip}{$parskip$}
$endif$

$if(fontfamily)$
\usepackage[$for(fontfamilyoptions)$$fontfamilyoptions$$sep$,$endfor$]{$fontfamily$}
$endif$

\ifPDFTeX\else
    % xetex/luatex font selection
$if(mainfont)$
  \setmainfont[$for(mainfontoptions)$$mainfontoptions$$sep$,$endfor$]{$mainfont$}
$endif$
$if(sansfont)$
  \setsansfont[$for(sansfontoptions)$$sansfontoptions$$sep$,$endfor$]{$sansfont$}
$endif$
$if(monofont)$
  \setmonofont[$for(monofontoptions)$$monofontoptions$$sep$,$endfor$]{$monofont$}
$endif$
$for(fontfamilies)$
  \newfontfamily{$fontfamilies.name$}[$for(fontfamilies.options)$$fontfamilies.options$$sep$,$endfor$]{$fontfamilies.font$}
$endfor$

$if(mathfont)$
$if(mathspec)$
  \ifXeTeX
    \setmathfont(Digits,Latin,Greek)[$for(mathfontoptions)$$mathfontoptions$$sep$,$endfor$]{$mathfont$}
  \else
    \setmathfont[$for(mathfontoptions)$$mathfontoptions$$sep$,$endfor$]{$mathfont$}
  \fi

$else$
  \setmathfont[$for(mathfontoptions)$$mathfontoptions$$sep$,$endfor$]{$mathfont$}
$endif$
$endif$

$if(CJKmainfont)$
  \ifXeTeX
    \usepackage{xeCJK}
    \setCJKmainfont[$for(CJKoptions)$$CJKoptions$$sep$,$endfor$]{$CJKmainfont$}
$if(CJKsansfont)$
    \setCJKsansfont[$for(CJKoptions)$$CJKoptions$$sep$,$endfor$]{$CJKsansfont$}
$endif$
$if(CJKmonofont)$
    \setCJKmonofont[$for(CJKoptions)$$CJKoptions$$sep$,$endfor$]{$CJKmonofont$}
$endif$
  \fi
$endif$

$if(luatexjapresetoptions)$
  \ifLuaTeX
    \usepackage[$for(luatexjapresetoptions)$$luatexjapresetoptions$$sep$,$endfor$]{luatexja-preset}
  \fi
$endif$

$if(CJKmainfont)$
  \ifLuaTeX
    \usepackage[$for(luatexjafontspecoptions)$$luatexjafontspecoptions$$sep$,$endfor$]{luatexja-fontspec}
    \setmainjfont[$for(CJKoptions)$$CJKoptions$$sep$,$endfor$]{$CJKmainfont$}
  \fi
$endif$
\fi

$if(zero-width-non-joiner)$
%% Support for zero-width non-joiner characters.
\makeatletter
\def\zerowidthnonjoiner{%
  % Prevent ligatures and adjust kerning, but still support hyphenating.
  \texorpdfstring{%
    \TextOrMath{\nobreak\discretionary{-}{}{\kern.03em}%
      \ifvmode\else\nobreak\hskip\z@skip\fi}{}%
  }{}%
}
\makeatother
\ifPDFTeX
  \DeclareUnicodeCharacter{200C}{\zerowidthnonjoiner}
\else
  \catcode`^^^^200c=\active
  \protected\def ^^^^200c{\zerowidthnonjoiner}
\fi
%% End of ZWNJ support
$endif$

% Set `abntex2` text variables -----

\renewcommand{\ABNTEXchapterfont}{\normalfont\bfseries}
\renewcommand{\ABNTEXchapterfontsize}{\normalsize}
\renewcommand{\ABNTEXsectionfont}{\normalfont}
\renewcommand{\ABNTEXsectionfontsize}{\normalsize}
\renewcommand{\ABNTEXsubsectionfont}{\normalfont\bfseries}
\renewcommand{\ABNTEXsubsectionfontsize}{\normalsize}
\renewcommand{\ABNTEXsubsubsectionfont}{\normalfont}
\renewcommand{\ABNTEXsubsubsectionfontsize}{\normalsize}
\renewcommand{\ABNTEXsubsubsubsectionfont}{\normalfont}
\renewcommand{\ABNTEXsubsubsubsectionfontsize}{\normalsize\itshape}
\renewcommand{\ABNTEXfontereduzida}{\footnotesize}

\renewcommand{\chapnumfont}{\normalfont}
\renewcommand{\captiontitlefont}{\ABNTEXfontereduzida}

\renewcommand{\ABNTEXcaptiondelim}{~\textendash~}
\renewcommand{\ABNTEXcaptionfontedelim}{:~}

% Set page numbering -----

\makepagestyle{abntheadings}
\makeevenhead{abntheadings}{\ABNTEXfontereduzida\thepage}{}{}
\makeoddhead{abntheadings}{}{}{\ABNTEXfontereduzida\thepage}

% Set footnote -----

\setlength{\footnotemargin}{0.5em} % Equal to `\footmarkwidth`
\let\svfootnoterule\footnoterule % Equal to `\footmarksep`
\renewcommand\footnoterule{\svfootnoterule\vspace{1ex}}

% Set language patterns -----

\newcommand{\capaname}{Capa}
\newcommand{\listadetermosname}{Lista de termos e definições}

\addto\captionsenglish{
  \renewcommand{\capaname}{Cover}
  \renewcommand{\folhadeaprovacaoname}{Approval sheet}
  \renewcommand{\dedicatorianame}{Inscription}
  \renewcommand{\contentsname}{Contents}
  \renewcommand{\listfigurename}{List of figures}
  \renewcommand{\listtablename}{List of tables}
  \renewcommand{\listadetermosname}{List of terms and definitions}
}

\addto\captionsbrazil{
  \renewcommand{\capaname}{Capa}
  \renewcommand{\contentsname}{Sumário}
  \renewcommand{\listfigurename}{Lista de figuras}
  \renewcommand{\listadetermosname}{Lista de termos e definições}
}

\addto\captionsspanish{
  \renewcommand{\capaname}{Portada}
  \renewcommand{\folhaderostoname}{Página de título}
  \renewcommand{\epigraphname}{Epígrafe}
  \renewcommand{\dedicatorianame}{Dedicatoria}
  \renewcommand{\errataname}{Errata}
  \renewcommand{\agradecimentosname}{Agradecimientos}
  \renewcommand{\anexoname}{Anexo}
  \renewcommand{\anexosname}{Anexos}
  \renewcommand{\apendicename}{Apéndice}
  \renewcommand{\apendicesname}{Apéndices}
  \renewcommand{\orientadorname}{Asesor:}
  \renewcommand{\coorientadorname}{Coasesor:}
  \renewcommand{\folhadeaprovacaoname}{Hoja de aprobación}
  \renewcommand{\resumoname}{Resumen}
  \renewcommand{\contentsname}{Sumario}
  \renewcommand{\listfigurename}{Lista de figuras}
  \renewcommand{\listtablename}{Lista de tablas}
  \renewcommand{\listadesiglasname}{Lista de abreviaturas y siglas}
  \renewcommand{\listadesimbolosname}{Lista de símbolos}
  \renewcommand{\listadetermosname}{Lista de términos y definiciones}
  \renewcommand{\contentsname}{Sumario}
  \renewcommand{\bibname}{Referencias}
  \renewcommand{\indexname}{Índice}
  \renewcommand{\sourcename}{Fuente}
  \renewcommand{\notaname}{Nota}
  \renewcommand{\pageautorefname}{página}
  \renewcommand{\sectionautorefname}{sección}
  \renewcommand{\subsectionautorefname}{subsección}
  \renewcommand{\subsubsectionautorefname}{subsubsección}
  \renewcommand{\paragraphautorefname}{subsubsubsección}
}

\addto\captionsfrench{
  \renewcommand{\capaname}{Page de titre}
  \renewcommand{\folhaderostoname}{Page de titre}
  \renewcommand{\epigraphname}{Épigraphe}
  \renewcommand{\dedicatorianame}{Dédiace}
  \renewcommand{\errataname}{Errata}
  \renewcommand{\agradecimentosname}{Remerciements}
  \renewcommand{\anexoname}{Annexe}
  \renewcommand{\anexosname}{Annexes}
  \renewcommand{\apendicename}{Appendice}
  \renewcommand{\apendicesname}{Appendices}
  \renewcommand{\orientadorname}{Conseiller :}
  \renewcommand{\coorientadorname}{Co-conseiller :}
  \renewcommand{\folhadeaprovacaoname}{Feuille d'approbation}
  \renewcommand{\resumoname}{Résumé}
  \renewcommand{\contentsname}{Sommaire}
  \renewcommand{\listfigurename}{Liste des figures}
  \renewcommand{\listtablename}{Liste des tableaux}
  \renewcommand{\listadesiglasname}{Liste des abréviations et sigles}
  \renewcommand{\listadesimbolosname}{Liste des symboles}
  \renewcommand{\listadetermosname}{Liste des termes et définitions}
  \renewcommand{\contentsname}{Sommaire}
  \renewcommand{\bibname}{Références}
  \renewcommand{\indexname}{Index}
  \renewcommand{\sourcename}{Source}
  \renewcommand{\notaname}{Note}
  \renewcommand{\pageautorefname}{page}
  \renewcommand{\sectionautorefname}{section}
  \renewcommand{\subsectionautorefname}{sous-section}
  \renewcommand{\subsubsectionautorefname}{sous-sous-section}
  \renewcommand{\paragraphautorefname}{sous-sous-sous-section}
}

% Set other general formatting -----

% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[$for(microtypeoptions)$$microtypeoptions$$sep$,$endfor$]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}

$if(verbatim-in-note)$
\usepackage{fancyvrb}
$endif$

$if(lhs)$
\lstnewenvironment{code}{\lstset{language=Haskell,basicstyle=\small\ttfamily}}{}
$endif$

$if(svg)$
\usepackage{svg}
$endif$

$if(strikeout)$
\ifLuaTeX
  \usepackage{luacolor}
  \usepackage[soul]{lua-ul}
\else
  \usepackage{soul}
$if(CJKmainfont)$
\ifXeTeX
  % soul's \st doesn't work for CJK:
  \usepackage{xeCJKfntef}
  \renewcommand{\st}[1]{\sout{#1}}
\fi
$endif$
\fi
$endif$

\setlength{\emergencystretch}{3em} % Prevent overfull lines

$if(numbersections)$
\setcounter{secnumdepth}{$if(secnumdepth)$$secnumdepth$$else$5$endif$}
$else$
\setcounter{secnumdepth}{-\maxdimen} % Remove section numbering
$endif$

$if(block-headings)$
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
$endif$

% Set pandoc -----

$pandoc.tex()$

% Set new commands -----

\providecommand{\imprimiruniversidade}{}
\newcommand{\universidade}[1]{\renewcommand{\imprimiruniversidade}{#1}}

\providecommand{\imprimirescola}{}
\newcommand{\escola}[1]{\renewcommand{\imprimirescola}{#1}}

\providecommand{\imprimirprograma}{}
\newcommand{\programa}[1]{\renewcommand{\imprimirprograma}{#1}}

\newcommand{\imprimirtipodetrabalho}{\imprimirtipotrabalho}

\providecommand{\imprimirtipodetituloacademico}{}
\newcommand{\tipodetituloacademico}[1]{\renewcommand{\imprimirtipodetituloacademico}{#1}}

\providecommand{\imprimirtituloacademico}{}
\newcommand{\tituloacademico}[1]{\renewcommand{\imprimirtituloacademico}{#1}}

\providecommand{\imprimirareadeconcentracao}{}
\newcommand{\areadeconcentracao}[1]{\renewcommand{\imprimirareadeconcentracao}{#1}}

\providecommand{\imprimirnotadeversao}{}
\newcommand{\notadeversao}[1]{\renewcommand{\imprimirnotadeversao}{#1}}

\makeatletter
\newcommand*{\getlength}[1]{\strip@pt#1}
\makeatother

% Set title variables -----

$title.tex()$

% Set hipersetup -----

\hypersetup{
$if(title-meta)$
pdftitle={$title-meta$},
$endif$
$if(author-meta)$
pdfauthor={$author-meta$},
$endif$
$if(lang)$
pdflang={$lang$},
$endif$
$if(type-of-work)$
pdfsubject={$type-of-work$},
$endif$
$if(keywords)$
pdfkeywords={$for(keywords)$$keywords$$sep$, $endfor$},
$endif$
$if(linktoc)$
linktoc={$linktoc$},
$endif$
$if(colorlinks)$
colorlinks=true,
linkcolor={$if(linkcolor)$$linkcolor$$else$blue$endif$},
filecolor={$if(filecolor)$$filecolor$$else$magenta$endif$},
citecolor={$if(citecolor)$$citecolor$$else$blue$endif$},
urlcolor={$if(urlcolor)$$urlcolor$$else$blue$endif$},
$else$
$if(boxlinks)$
$else$
hidelinks,
$endif$
$endif$
pdfcreator={LaTeX via pandoc},
bookmarksdepth=5
}

% Set chapter/section formating -----

\setsecnumformat{\normalfont\csname the#1\endcsname\quad}

\renewcommand{\printchapternum}{
  \tocprintchapter
  \setboolean{abntex@innonumchapter}{false}
  \chapnumfont
  \thechapter \quad
  \ifthenelse{\boolean{abntex@apendiceousecao}}{
      \tocinnonumchapter
      \ABNTEXcaptiondelim
  }{}
}

\setlength{\beforechapskip}{2.5em}
\setlength{\afterchapskip}{1em}
\setbeforesecskip{1.5em}
\setaftersecskip{1em}
\setbeforesubsecskip{1.5em}
\setaftersubsecskip{1em}
\setbeforesubsubsecskip{1.5em}
\setaftersubsubsecskip{1em}
\setbeforeparaskip{1.5em}
\setafterparaskip{0em} % check
\setparahook{\vspace{1.5em}}

% Set tabular environment -----

% \providecommand{\addquartolegend}{}
% \newcommand{\quartolegend}[1]{\renewcommand{\addquartolegend}{#1}}
% \renewcommand{\quartolegend}{Don't forget to set \verb|\quartolegend|!}

\AtBeginEnvironment{table}{\ABNTEXfontereduzida}
\AtBeginEnvironment{tabular}{\ABNTEXfontereduzida}
\renewcommand{\arraystretch}{1.5}
\setlength{\aboverulesep}{0ex}
\setlength{\belowrulesep}{0ex}

\AddToHook{env/longtable/before}{}
\AddToHook{env/longtable/after}{}
\AddToHook{env/longtable/begin}{
  \ABNTEXfontereduzida
  \renewcommand{\arraystretch}{1.5}
}
\AddToHook{env/longtable/end}{}

% Set figure environment -----

\makeatletter
\setlength{\@fptop}{5pt} % Set distance from top of page to first float
\makeatother

\renewcommand{\legend}[1]{
  \vspace*{1\baselineskip}
  \ABNTEXfontereduzida \raggedright #1
  \vspace{1.5\baselineskip}
}

% % Credits: <https://stackoverflow.com/a/1566053/8258804>.
% \makeatletter
% \let\oldfigure\figure
% \def\figure{\@ifnextchar[\figure@i \figure@ii}
% \def\figure@i[#1]{\oldfigure[#1]\centering}
% \def\figure@ii{\oldfigure\centering}
% \makeatother

% Change `abntex2` commands and enviroments -----

$if(index-page)$
\usepackage{makeidx}
\makeindex
$endif$

% Similar to \printloftitle
\renewcommand{\pretextualchapter}[1]{
  \setlength{\afterchapskip}{4.5em}
  \addtocounter{abntex@bookmarkcounter}{1}
  \PRIVATEbookmarkthis{#1}
  \chapter*[#1]{#1}
}

\renewcommand{\textual}{
  \pagestyle{abntheadings}
  \aliaspagestyle{chapter}{abntheadings}
}

\renewcommand{\imprimircapa}{
  \phantomsection\pdfbookmark[0]{\capaname}{}
  \begin{capa}%
  \begin{adjustwidth}{-1cm}{0cm}
  \center
  \imprimirinstituicao
  \vfill

  \imprimirautor
  \vfill

  \textbf{\imprimirtitulo}
  \vspace{10cm}

  \imprimirlocal

  \imprimirdata
  \vspace*{1.5cm}
  \end{adjustwidth}
  \end{capa}
}

\makeatletter
\renewcommand{\folhaderostocontent}{
  \begin{center}
  \imprimirautor
  \vfill

  \textbf{\imprimirtitulo}
  \vfill

  \abntex@ifnotempty{
    \imprimirpreambulo
  }{
    \hspace{0.35\textwidth}
    \begin{minipage}{.6\textwidth} % page width
    \SingleSpacing
    \imprimirpreambulo
    \end{minipage}
    \vfill
  }

  \imprimirlocal

  \imprimirdata
  \vspace*{1cm}
  \end{center}
}
\makeatother

\renewenvironment{fichacatalografica}{
  \ABNTEXfontereduzida
  \setlength{\parindent}{0cm}
  \begin{SingleSpacing}
}{
  \end{SingleSpacing}%
}

\renewenvironment{siglas}{
  \pretextualchapter{\listadesiglasname}
}{
  \cleardoublepage
}

\renewenvironment{simbolos}{
  \pretextualchapter{\listadesimbolosname}
}{
  \cleardoublepage
}

\newenvironment{termos}{%
  \pretextualchapter{\listadetermosname}
}{
  \cleardoublepage
}

\newenvironment{resumoenv}[1][\resumoname]{
  \pretextualchapter{#1}
  \setlength{\parindent}{0cm}
  \setlength{\parskip}{1em}
  \AtBeginEnvironment{tabular}{\normalsize}
  \renewcommand{\arraystretch}{1}
  \setlength{\aboverulesep}{0em}
  \setlength{\belowrulesep}{0em}
  \setlength{\arrayrulewidth}{0em}
  \setlength{\tabcolsep}{0em}
  \begin{SingleSpace}
}{
  \end{SingleSpace}
  \clearpage
}

\makechapterstyle{apendice}{
  \setlength{\beforechapskip}{-\baselineskip}
  \setlength{\midchapskip}{0em}
  \setlength{\afterchapskip}{1em}
  \renewcommand{\chapnamefont}{\normalfont}
  \renewcommand{\printchaptername}{\ABNTEXchapterupperifneeded{\appendixname}}
  \renewcommand{\chapternamenum}{\space}
  \renewcommand{\chapnumfont}{\normalfont}
  \renewcommand{\printchapternum}{\thechapter}
  \renewcommand{\afterchapternum}{\space -- \space}
  \renewcommand{\chaptitlefont}{\normalfont}
  \renewcommand{\printchaptertitle}[1]{\ABNTEXchapterupperifneeded{##1}}
  \renewcommand{\afterchaptertitle}{\vspace{1em}}
}

\renewcommand{\PRIVATEapendiceconfig}[1]{
  \setboolean{abntex@apendiceousecao}{true}
  \renewcommand{\appendixname}{#1}
  \renewcommand{\apendicesname}{#1}
  \switchchapname{#1}

  % Note:
  %
  % \cleardoublepage
  % \phantomsection
  % \addcontentsline{toc}{part}{Appendices}
  % \appendix
  %
  % is automatically add by the Quarto render.
}

\newcommand{\PRIVATEannexconfig}[2]{
  \setboolean{abntex@apendiceousecao}{true}
  \renewcommand{\appendixname}{#1}
  \renewcommand{\apendicesname}{#1}
  \renewcommand{\appendixtocname}{#2}
  \phantomsection
  \addcontentsline{toc}{part}{\appendixtocname}
  \switchchapname{#1}
}

\renewcommand{\apendices}{
  \cftinserthook{toc}{appendixhook}
  \PRIVATEapendiceconfig{\apendicename}
  \appendix
  \chapterstyle{apendice}
}

\renewenvironment{apendicesenv}{
  \cftinserthook{toc}{appendixhook}
  \PRIVATEapendiceconfig{\apendicename}
  \begin{appendix}
  \chapterstyle{apendice}
}{
  \end{appendix}
  \setboolean{abntex@apendiceousecao}{false}
  \bookmarksetup{startatroot}
}

\renewcommand{\anexos}{
  \cftinserthook{toc}{appendixhook}
  \PRIVATEannexconfig{\anexoname}{\anexosname}
  \appendix
  \renewcommand\theHchapter{anexochapback.\arabic{chapter}}
  \chapterstyle{apendice}
}

\renewenvironment{anexosenv}{
  \cftinserthook{toc}{appendixhook}
  \PRIVATEannexconfig{\anexoname}{\anexosname}
  \begin{appendix}
  \renewcommand\theHchapter{anexochapback.\arabic{chapter}}
  \chapterstyle{apendice}
}{
  \end{appendix}
  \setboolean{abntex@apendiceousecao}{false}
  \bookmarksetup{startatroot}
}

% Set LoF & LoT -----

\renewcommand{\printloftitle}[1]{
  \setlength{\afterchapskip}{2.3em}
  \chapter*[#1]{#1}
}

\renewcommand{\printlottitle}[1]{
  \setlength{\afterchapskip}{2.3em}
  \chapter*[#1]{#1}
}

% Set ToC -----

$toc.tex()$

% Set bibliography -----

$if(biblio-title)$
\renewcommand{\bibname}{$biblio-title$}
\newcommand{\newbibname}{$biblio-title$}
$endif$

$if(biblio-footnote)$
\newcommand{\bibnamewithfootnote}{
  $biblio-title$\protect\footnote{$biblio-footnote$}
}
$endif$

\usepackage[
$if(biblio-style)$style=$biblio-style$,$endif$$for(biblatexoptions)$$biblatexoptions$$sep$,$endfor$]{biblatex}
\usepackage{csquotes}
$for(bibliography)$
\addbibresource{$bibliography$}
$endfor$

\defbibheading{bay}$if(biblio-footnote)$[\bibnamewithfootnote]$else$[\newbibname]$endif${
  \ifthenelse{\boolean{ABNTEXupperchapter}}{
    \setboolean{ABNTEXupperchapter}{false}
    \chapter*{#1}
    \markboth{#1}{#1}
    \setboolean{ABNTEXupperchapter}{true}
  }{
    \chapter*{#1}
    \markboth{#1}{#1}
  }
}

\AtBeginBibliography{\vspace{4em}}
\AtEveryBibitem{\clearfield{annotation}}
\renewcommand{\bibfont}{\ABNTEXfontereduzida}

$if(bibhang)$
\setlength{\bibhang}{$bibhang$}
$endif$

$if(bibparsep)$
\setlength{\bibparsep}{$bibparsep$}
$endif$

$if(nocite-ids)$
\nocite{$for(nocite-ids)$$it$$sep$, $endfor$}
$endif$

% Set colors -----

$colors.tex()$

% Other settings -----

\floatplacement{table}{H}
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}

\clubpenalty10000
\widowpenalty10000
\displaywidowpenalty10000

\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi

$if(dir)$
\ifPDFTeX
  \TeXXeTstate=1
  \newcommand{\RL}[1]{\beginR #1\endR}
  \newcommand{\LR}[1]{\beginL #1\endL}
  \newenvironment{RTL}{\beginR}{\endR}
  \newenvironment{LTR}{\beginL}{\endL}
\fi
$endif$

\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs

$if(links-as-notes)$
% Make links footnotes instead of hotlinks:
\DeclareRobustCommand{\href}[2]{#2\footnote{\url{#1}}}
$endif$

$if(verbatim-in-note)$
\VerbatimFootnotes % allow verbatim text in footnotes
$endif$

% -----
% Body
% -----

\begin{document}

% Top matter -----

\pretextual

$before-body.tex()$

$for(include-before)$
$include-before$
$endfor$

% Main and back matter -----

\textual
$body$

$for(include-after)$
$include-after$
$endfor$

\end{document}
